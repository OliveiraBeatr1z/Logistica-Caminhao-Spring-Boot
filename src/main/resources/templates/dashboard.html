<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragmentos/head :: head('Dashboard - FrotaLux')}"></head>
<body>
    <header th:replace="~{fragmentos/header :: header(activePage='dashboard')}"></header>
    
    <div class="container-fluid py-4">
        <!-- Título -->
        <div class="mb-4">
            <h2 class="mb-1">
                <i class="fas fa-tachometer-alt text-primary-blue"></i> Dashboard
            </h2>
            <p class="text-secondary-gray">Visão geral da operação em tempo real</p>
        </div>

        <!-- Cards de Estatísticas -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card-stat">
                    <div class="card-stat-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="card-stat-value" id="total-entregas">0</div>
                    <div class="card-stat-label">Total de Entregas</div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card-stat" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">
                    <div class="card-stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="card-stat-value" id="entregas-andamento">0</div>
                    <div class="card-stat-label">Em Andamento</div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card-stat" style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%);">
                    <div class="card-stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="card-stat-value" id="entregas-hoje">0</div>
                    <div class="card-stat-label">Concluídas Hoje</div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card-stat" style="background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);">
                    <div class="card-stat-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="card-stat-value" id="alertas-manutencao">0</div>
                    <div class="card-stat-label">Alertas de Manutenção</div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="row mb-4">
            <!-- Gráfico de Entregas (Linha) -->
            <div class="col-lg-8 mb-4">
                <div class="card-modern">
                    <div class="card-header">
                        <i class="fas fa-chart-line"></i> Entregas nos Últimos 7 Dias
                    </div>
                    <div class="card-body">
                        <div style="height: 300px;">
                            <canvas id="weekly-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Status (Pizza) -->
            <div class="col-lg-4 mb-4">
                <div class="card-modern">
                    <div class="card-header">
                        <i class="fas fa-chart-pie"></i> Status das Entregas
                    </div>
                    <div class="card-body">
                        <div style="height: 300px;">
                            <canvas id="status-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Alertas de Manutenção -->
            <div class="col-lg-6 mb-4">
                <div class="card-modern">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-tools"></i> Alertas de Manutenção</span>
                        <a th:href="@{/manutencoes/alertas}" class="btn btn-sm btn-corporate-primary">
                            Ver Todos
                        </a>
                    </div>
                    <div class="card-body">
                        <div id="alertas-container">
                            <div class="text-center text-secondary-gray py-4">
                                <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                <p>Carregando alertas...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Entregas Recentes -->
            <div class="col-lg-6 mb-4">
                <div class="card-modern">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-list"></i> Entregas Recentes</span>
                        <a th:href="@{/solicitacoes/mostrar}" class="btn btn-sm btn-corporate-primary">
                            Ver Todas
                        </a>
                    </div>
                    <div class="card-body">
                        <div id="entregas-recentes-container">
                            <div class="text-center text-secondary-gray py-4">
                                <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                <p>Carregando entregas...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mapa da Frota -->
        <div class="row">
            <div class="col-12">
                <div class="card-modern">
                    <div class="card-header">
                        <i class="fas fa-map"></i> Localização da Frota
                    </div>
                    <div class="card-body p-0">
                        <div id="fleet-map" class="map-container" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{fragmentos/footer :: footer}"></div>

    <!-- Scripts de inicialização -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Dados de exemplo - em produção viriam do backend via Thymeleaf
            const dadosUltimos7Dias = {
                labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'],
                dados: [12, 15, 10, 18, 22, 8, 5]
            };

            const dadosStatus = [5, 8, 12, 45]; // Coleta, Processamento, A Caminho, Entregue

            // Criar gráficos
            FrotaCharts.createWeeklyLineChart('weekly-chart', dadosUltimos7Dias.labels, dadosUltimos7Dias.dados);
            FrotaCharts.createStatusPieChart('status-chart', dadosStatus);

            // Animar contadores
            FrotaLux.animateCounter(document.getElementById('total-entregas'), 70);
            FrotaLux.animateCounter(document.getElementById('entregas-andamento'), 25);
            FrotaLux.animateCounter(document.getElementById('entregas-hoje'), 8);
            FrotaLux.animateCounter(document.getElementById('alertas-manutencao'), 3);

            // Carregar alertas via AJAX
            try {
                const alertasContainer = document.getElementById('alertas-container');
                alertasContainer.innerHTML = `
                    <div class="alert alert-modern alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <strong>2 caminhões</strong> precisam de manutenção preventiva
                    </div>
                    <div class="alert alert-modern alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>1 caminhão</strong> próximo da troca de pneus
                    </div>
                    <div class="text-center mt-3">
                        <a href="/manutencoes/alertas" class="btn btn-corporate-primary btn-sm">
                            Ver Detalhes Completos
                        </a>
                    </div>
                `;
            } catch (error) {
                console.error('Erro ao carregar alertas:', error);
            }

            // Carregar entregas recentes via AJAX
            try {
                const entregasContainer = document.getElementById('entregas-recentes-container');
                entregasContainer.innerHTML = `
                    <div class="list-group list-group-flush">
                        <a href="/solicitacoes/mostrar/1" class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Notebook Dell</h6>
                                    <small class="text-secondary-gray">São Paulo → Rio de Janeiro</small>
                                </div>
                                <span class="badge badge-modern badge-status-caminho">A Caminho</span>
                            </div>
                        </a>
                        <a href="/solicitacoes/mostrar/2" class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Peças Automotivas</h6>
                                    <small class="text-secondary-gray">Campinas → Santos</small>
                                </div>
                                <span class="badge badge-modern badge-status-processamento">Processamento</span>
                            </div>
                        </a>
                        <a href="/solicitacoes/mostrar/3" class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Equipamentos Médicos</h6>
                                    <small class="text-secondary-gray">Belo Horizonte → Brasília</small>
                                </div>
                                <span class="badge badge-modern badge-status-coleta">Coleta</span>
                            </div>
                        </a>
                    </div>
                `;
            } catch (error) {
                console.error('Erro ao carregar entregas:', error);
            }

            // Inicializar mapa da frota (exemplo)
            // Em produção, os dados viriam do backend
            const motoristasExemplo = [];
            // FrotaMaps.initFleetMap('fleet-map', motoristasExemplo);
            
            // Placeholder para mapa da frota
            document.getElementById('fleet-map').innerHTML = `
                <div class="d-flex align-items-center justify-content-center h-100 bg-light">
                    <div class="text-center text-secondary-gray">
                        <i class="fas fa-map fa-3x mb-3"></i>
                        <p>Mapa da frota será exibido quando houver motoristas com GPS ativo</p>
                    </div>
                </div>
            `;
        });
    </script>
</body>
</html>

