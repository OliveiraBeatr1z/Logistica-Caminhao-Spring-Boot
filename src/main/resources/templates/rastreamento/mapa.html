<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragmentos/head :: head('Rastreamento de Entrega')}"></head>
<body>
    <header th:replace="~{fragmentos/header :: header(activePage='Solicitacao')}"></header>
    
    <div class="container-fluid py-4">
        <!-- Título -->
        <div class="row mb-4">
            <div class="col-md-12">
                <h2 class="mb-1">
                    <i class="fas fa-map-marked-alt text-primary-blue"></i> 
                    Rastreamento de Entrega #<span th:text="${solicitacao.id}"></span>
                </h2>
                <p class="text-secondary-gray">
                    <strong th:text="${solicitacao.produto}"></strong> - 
                    De <span th:text="${solicitacao.origemEndereco}"></span> 
                    para <span th:text="${solicitacao.destinoEndereco}"></span>
                </p>
            </div>
        </div>

        <div class="row">
            <!-- Coluna do Mapa -->
            <div class="col-lg-8 mb-4">
                <div class="card-modern">
                    <div class="card-header">
                        <i class="fas fa-globe"></i> Mapa em Tempo Real
                    </div>
                    <div class="card-body p-0">
                        <div id="tracking-map" class="map-container" style="height: 500px;"></div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="card-modern mt-4">
                    <div class="card-header">
                        <i class="fas fa-history"></i> Histórico da Entrega
                    </div>
                    <div class="card-body">
                        <div class="timeline">
                            <!-- Coleta -->
                            <div class="timeline-item">
                                <div class="timeline-icon" 
                                     th:classappend="${solicitacao.dataHoraColeta != null ? 'completed' : (solicitacao.status.name() == 'COLETA' ? 'active' : 'pending')}">
                                    <i class="fas fa-box"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Coleta Programada</h6>
                                    <p class="timeline-time mb-1" th:if="${solicitacao.horarioColetaProgramado != null}">
                                        Programado: <span th:text="${#temporals.format(solicitacao.horarioColetaProgramado, 'dd/MM/yyyy HH:mm')}"></span>
                                    </p>
                                    <p class="timeline-time mb-0" th:if="${solicitacao.dataHoraColeta != null}">
                                        Realizado: <span th:text="${#temporals.format(solicitacao.dataHoraColeta, 'dd/MM/yyyy HH:mm')}"></span>
                                    </p>
                                    <p class="timeline-time mb-0" th:if="${solicitacao.dataHoraColeta == null}">
                                        Aguardando coleta
                                    </p>
                                </div>
                            </div>

                            <!-- Em Processamento -->
                            <div class="timeline-item">
                                <div class="timeline-icon" 
                                     th:classappend="${solicitacao.dataHoraProcessamento != null ? 'completed' : (solicitacao.status.name() == 'EM_PROCESSAMENTO' ? 'active' : 'pending')}">
                                    <i class="fas fa-cogs"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Em Processamento</h6>
                                    <p class="timeline-time mb-0" th:if="${solicitacao.dataHoraProcessamento != null}">
                                        <span th:text="${#temporals.format(solicitacao.dataHoraProcessamento, 'dd/MM/yyyy HH:mm')}"></span>
                                    </p>
                                    <p class="timeline-time mb-0" th:if="${solicitacao.dataHoraProcessamento == null}">
                                        Pendente
                                    </p>
                                </div>
                            </div>

                            <!-- A Caminho -->
                            <div class="timeline-item">
                                <div class="timeline-icon" 
                                     th:classappend="${solicitacao.dataHoraACaminho != null ? 'completed' : (solicitacao.status.name() == 'A_CAMINHO' ? 'active' : 'pending')}">
                                    <i class="fas fa-truck-moving"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">A Caminho da Entrega</h6>
                                    <p class="timeline-time mb-0" th:if="${solicitacao.dataHoraACaminho != null}">
                                        <span th:text="${#temporals.format(solicitacao.dataHoraACaminho, 'dd/MM/yyyy HH:mm')}"></span>
                                    </p>
                                    <p class="timeline-time mb-0" th:if="${solicitacao.dataHoraACaminho == null}">
                                        Pendente
                                    </p>
                                </div>
                            </div>

                            <!-- Entregue -->
                            <div class="timeline-item">
                                <div class="timeline-icon" 
                                     th:classappend="${solicitacao.dataHoraEntregue != null ? 'completed' : (solicitacao.status.name() == 'ENTREGUE' ? 'active' : 'pending')}">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Entrega Realizada</h6>
                                    <p class="timeline-time mb-0" th:if="${solicitacao.dataHoraEntregue != null}">
                                        <span th:text="${#temporals.format(solicitacao.dataHoraEntregue, 'dd/MM/yyyy HH:mm')}"></span>
                                    </p>
                                    <p class="timeline-time mb-0" th:if="${solicitacao.dataHoraEntregue == null}">
                                        Pendente
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coluna de Informações -->
            <div class="col-lg-4">
                <!-- Card Status -->
                <div class="card-modern mb-3">
                    <div class="card-header">
                        <i class="fas fa-info-circle"></i> Status Atual
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <span class="badge badge-modern" 
                                  th:classappend="${'badge-status-' + #strings.toLowerCase(solicitacao.status.name())}"
                                  style="font-size: 1.1rem; padding: 0.5rem 1rem;">
                                <span th:text="${solicitacao.status.nome}"></span>
                            </span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="fas fa-road text-info"></i> Distância Total:</span>
                            <strong th:text="${solicitacao.distanciaKm != null ? #numbers.formatDecimal(solicitacao.distanciaKm, 1, 1) + ' km' : 'N/A'}"></strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2" id="distance-remaining">
                            <span><i class="fas fa-route text-warning"></i> Distância Restante:</span>
                            <strong class="distance-text">Calculando...</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-clock text-primary"></i> Tempo Estimado:</span>
                            <strong class="time-text">Calculando...</strong>
                        </div>
                    </div>
                </div>

                <!-- Card Motorista -->
                <div class="card-modern mb-3" th:if="${solicitacao.motorista != null}">
                    <div class="card-header">
                        <i class="fas fa-user-tie"></i> Motorista
                    </div>
                    <div class="card-body">
                        <h5 class="mb-2" th:text="${solicitacao.motorista.nome}"></h5>
                        <p class="mb-1 text-secondary-gray">
                            <i class="fas fa-id-card me-2"></i> CNH: <span th:text="${solicitacao.motorista.cnh}"></span>
                        </p>
                        <p class="mb-1 text-secondary-gray">
                            <i class="fas fa-phone me-2"></i> <span th:text="${solicitacao.motorista.telefone}"></span>
                        </p>
                        <p class="mb-0">
                            <span class="badge" th:classappend="${solicitacao.motorista.cnhValida() ? 'badge-cnh-valida' : 'badge-cnh-vencida'}">
                                <span th:text="${solicitacao.motorista.cnhValida() ? 'CNH Válida' : 'CNH Vencida'}"></span>
                            </span>
                        </p>
                    </div>
                </div>

                <!-- Card Produto -->
                <div class="card-modern">
                    <div class="card-header">
                        <i class="fas fa-cube"></i> Detalhes do Produto
                    </div>
                    <div class="card-body">
                        <h6 class="mb-2" th:text="${solicitacao.produto}"></h6>
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-secondary-gray">Peso Real:</span>
                            <strong th:text="${#numbers.formatDecimal(solicitacao.pesoReal, 1, 2)} + ' kg'"></strong>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-secondary-gray">Peso Cubado:</span>
                            <strong th:text="${#numbers.formatDecimal(solicitacao.calcularPesoCubado(), 1, 2)} + ' kg'"></strong>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-secondary-gray">Volume:</span>
                            <strong th:text="${#numbers.formatDecimal(solicitacao.calcularVolume(), 1, 4)} + ' m³'"></strong>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <span class="text-secondary-gray">Valor do Frete:</span>
                            <strong class="text-primary-blue" th:text="'R$ ' + ${#numbers.formatDecimal(solicitacao.valorFrete, 1, 2)}"></strong>
                        </div>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="mt-3 d-grid gap-2">
                    <a th:href="@{/solicitacoes/mostrar/{id}(id=${solicitacao.id})}" 
                       class="btn btn-corporate btn-corporate-secondary">
                        <i class="fas fa-arrow-left"></i> Voltar aos Detalhes
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{fragmentos/footer :: footer}"></div>

    <!-- Script de inicialização do mapa -->
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const solicitacaoId = /*[[${solicitacao.id}]]*/ 1;
            
            // Inicializar mapa de rastreamento
            const map = FrotaMaps.initTrackingMap('tracking-map', solicitacaoId);
            
            // Atualizar informações a cada 30 segundos
            async function atualizarInformacoes() {
                try {
                    const response = await fetch(`/api/rastreamento/${solicitacaoId}/posicao`);
                    const data = await response.json();
                    
                    // Atualizar distância restante e tempo
                    if (data.distanciaRestante !== null) {
                        document.querySelector('.distance-text').textContent = 
                            data.distanciaRestante.toFixed(1) + ' km';
                    }
                    
                    if (data.tempoEstimado) {
                        document.querySelector('.time-text').textContent = data.tempoEstimado;
                    }
                } catch (error) {
                    console.error('Erro ao atualizar informações:', error);
                }
            }
            
            // Executar imediatamente e depois a cada 30 segundos
            atualizarInformacoes();
            setInterval(atualizarInformacoes, 30000);
        });
    </script>
</body>
</html>

